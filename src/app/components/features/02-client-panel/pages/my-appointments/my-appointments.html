
<div class="appointments-container">
  <h1 class="title">
    <i class="fas fa-calendar-check"></i>
    Mis Citas
  </h1>
  <p class="subtitle">Aquí puedes ver tus citas agendadas y tu historial.</p>

  <mat-progress-bar *ngIf="loading" mode="indeterminate" color="primary"></mat-progress-bar>

  <div
    *ngIf="!loading && upcomingAppointments.length === 0 && historyAppointments.length === 0"
    class="empty-state">
    <i class="fas fa-calendar-times fa-3x"></i>
    <p>No tienes citas agendadas aún.</p>
    <button mat-raised-button color="primary" routerLink="/cliente/profesionales">
      <i class="fas fa-search"></i> Buscar Profesionales
    </button>
  </div>

  <div *ngIf="!loading && upcomingAppointments.length > 0" class="section">
    <h2 class="section-title">
      <i class="fas fa-clock"></i>
      Próximas Citas ({{ upcomingAppointments.length }})
    </h2>

    <table mat-table [dataSource]="upcomingAppointments" class="appointments-table mat-elevation-z2">

      <ng-container matColumnDef="professional">
        <th mat-header-cell *matHeaderCellDef> Profesional </th>
        <td mat-cell *matCellDef="let row">
          <div class="professional-cell">
            <i class="fas fa-user-md"></i>
            <span>{{ row.professionalName }} {{ row.professionalLastname }}</span>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef> Fecha </th>
        <td mat-cell *matCellDef="let row">
          <div class="date-cell">
            <i class="fas fa-calendar-day"></i>
            {{ formatDate(row.date) }}
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="time">
        <th mat-header-cell *matHeaderCellDef> Hora </th>
        <td mat-cell *matCellDef="let row">
          <div class="time-cell">
            <i class="fas fa-clock"></i>
            {{ row.timeStart | slice:0:5 }} - {{ row.timeEnds | slice:0:5 }}
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef> Estado </th>
        <td mat-cell *matCellDef="let row">
          <mat-chip [color]="getStatusColor(row.status)" selected>
            {{ getStatusIcon(row.status) }} {{ row.status }}
          </mat-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Acciones </th>
        <td mat-cell *matCellDef="let row">
          <button
            mat-stroked-button
            color="warn"
            *ngIf="row.status === 'PROGRAMADA' || row.status === 'CONFIRMADA'"
            (click)="cancelAppointment(row)">
            <i class="fas fa-times"></i> Cancelar
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumnsUpcoming"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumnsUpcoming;"
          [class.highlighted-row]="isToday(row.date)"></tr>
    </table>
  </div>

  <div *ngIf="!loading && historyAppointments.length > 0" class="section">
    <h2 class="section-title">
      <i class="fas fa-history"></i>
      Citas ({{ historyAppointments.length }})
    </h2>

    <table mat-table [dataSource]="historyAppointments" class="appointments-table mat-elevation-z2">

      <ng-container matColumnDef="professional">
        <th mat-header-cell *matHeaderCellDef> Profesional </th>
        <td mat-cell *matCellDef="let row">
          <div class="professional-cell">
            <i class="fas fa-user-md"></i>
            <span>{{ row.professionalName }} {{ row.professionalLastname }}</span>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef> Fecha </th>
        <td mat-cell *matCellDef="let row">
          <div class="date-cell">
            <i class="fas fa-calendar-day"></i>
            {{ formatDate(row.date) }}
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="time">
        <th mat-header-cell *matHeaderCellDef> Hora </th>
        <td mat-cell *matCellDef="let row">
          <div class="time-cell">
            <i class="fas fa-clock"></i>
            {{ row.timeStart | slice:0:5 }} - {{ row.timeEnds | slice:0:5 }}
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef> Estado </th>
        <td mat-cell *matCellDef="let row">
          <mat-chip [color]="getStatusColor(row.status)" selected>
            {{ getStatusIcon(row.status) }} {{ row.status }}
          </mat-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="historyActions">
        <th mat-header-cell *matHeaderCellDef> Acciones </th>
        <td mat-cell *matCellDef="let row">
          <div class="actions-group">

            <button
              mat-stroked-button
              color="primary"
              (click)="showSharedHistory(row)"
              class="action-btn"
              matTooltip="Ver todas las citas con este profesional">
              <i class="fas fa-history"></i> Historial
            </button>

            <ng-container *ngIf="row.status === 'COMPLETADA'">
              <button
                mat-stroked-button
                color="primary"
                (click)="showChat(row.id)"
                class="action-btn">
                <i class="fas fa-comments"></i> Chat
              </button>

              <button
                mat-stroked-button
                color="accent"
                (click)="showSummary(row.id)"
                class="action-btn">
                <i class="fas fa-file-alt"></i> Conclusión
              </button>
            </ng-container>

            <ng-container *ngIf="row.status === 'CANCELADA' || row.status === 'INASISTENCIA'">
              <button
                mat-stroked-button
                color="accent"
                (click)="showSummary(row.id)"
                class="action-btn">
                <i class="fas fa-file-alt"></i> Conclusión
              </button>
            </ng-container>

          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumnsHistory"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumnsHistory;"></tr>
    </table>
  </div>
</div>
