<div class="appointments-container">
  <h1 class="title">Mis Citas</h1>
  <p class="subtitle">Aquí puedes ver tus citas agendadas y tu historial.</p>

  <!-- Loader -->
  <mat-progress-bar *ngIf="loading" mode="indeterminate"></mat-progress-bar>

  <!-- Cuando no hay citas -->
  <div
    *ngIf="!loading && upcomingAppointments.length === 0 && historyAppointments.length === 0"
    class="empty-state">
    No se encontraron citas agendadas.
  </div>

  <!-- Próximas citas -->
  <div *ngIf="!loading && upcomingAppointments.length > 0" class="section">
    <h2 class="section-title">Próximas citas</h2>

    <table mat-table [dataSource]="upcomingAppointments" class="appointments-table mat-elevation-z1">

      <!-- Profesional -->
      <ng-container matColumnDef="professional">
        <th mat-header-cell *matHeaderCellDef> Profesional </th>
        <td mat-cell *matCellDef="let row">
          {{ row.professionalName }} {{ row.professionalLastname }}
        </td>
      </ng-container>

      <!-- Fecha -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef> Fecha </th>
        <td mat-cell *matCellDef="let row"> {{ row.date }} </td>
      </ng-container>

      <!-- Hora -->
      <ng-container matColumnDef="time">
        <th mat-header-cell *matHeaderCellDef> Hora </th>
        <td mat-cell *matCellDef="let row">
          {{ row.timeStart | slice:0:5 }} - {{ row.timeEnds | slice:0:5 }}
        </td>
      </ng-container>

      <!-- Estado -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef> Estado </th>
        <td mat-cell *matCellDef="let row"> {{ row.status }} </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef> Acciones </th>
        <td mat-cell *matCellDef="let row">
          <button
            mat-button
            color="warn"
            *ngIf="row.status === 'PROGRAMADA' || row.status === 'CONFIRMADA'"
            (click)="cancelAppointment(row)">
            Cancelar
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumnsUpcoming"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumnsUpcoming;"></tr>
    </table>
  </div>

  <!-- Historial -->
  <div *ngIf="!loading && historyAppointments.length > 0" class="section">
    <h2 class="section-title">Historial</h2>

    <table mat-table [dataSource]="historyAppointments" class="appointments-table mat-elevation-z1">

      <!-- Profesional -->
      <ng-container matColumnDef="professional">
        <th mat-header-cell *matHeaderCellDef> Profesional </th>
        <td mat-cell *matCellDef="let row">
          {{ row.professionalName }} {{ row.professionalLastname }}
        </td>
      </ng-container>

      <!-- Fecha -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef> Fecha </th>
        <td mat-cell *matCellDef="let row"> {{ row.date }} </td>
      </ng-container>

      <!-- Hora -->
      <ng-container matColumnDef="time">
        <th mat-header-cell *matHeaderCellDef> Hora </th>
        <td mat-cell *matCellDef="let row">
          {{ row.timeStart | slice:0:5 }} - {{ row.timeEnds | slice:0:5 }}
        </td>
      </ng-container>

      <!-- Estado -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef> Estado </th>
        <td mat-cell *matCellDef="let row"> {{ row.status }} </td>
      </ng-container>

      <!-- Acciones solo lectura -->
      <!-- Acciones (historial) -->
      <ng-container matColumnDef="historyActions">
        <th mat-header-cell *matHeaderCellDef> Acciones </th>
        <td mat-cell *matCellDef="let row">

          <!-- Caso 1: COMPLETADA -> Ver chat + Ver conclusión -->
          <ng-container *ngIf="row.status === 'COMPLETADA'; else otherStates">
            <button
              mat-stroked-button
              color="primary"
              (click)="showChat(row.id)">
              Ver chat
            </button>

            <button
              mat-stroked-button
              color="accent"
              style="margin-left: 8px"
              (click)="showSummary(row.id)">
              Ver conclusión
            </button>
          </ng-container>

          <!-- Caso 2: CANCELADA o INASISTENCIA -> solo Ver conclusión -->
          <ng-template #otherStates>
            <ng-container *ngIf="row.status === 'CANCELADA' || row.status === 'INASISTENCIA'; else noActions">
              <button
                mat-stroked-button
                color="accent"
                (click)="showSummary(row.id)">
                Ver conclusión
              </button>
            </ng-container>

            <!-- Caso 3: otros estados -> nada -->
            <ng-template #noActions>
              <span>-</span>
            </ng-template>
          </ng-template>

        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumnsHistory"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumnsHistory;"></tr>
    </table>
  </div>
</div>
